<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Logaritimos</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="./CSS/cadastro.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>

<body onload="listar()">
  <!--Header-->

  <header>
    <div>
      <img src="./assets/imagem/logo.png" alt="">
    </div>
    <div class="links">
      <ul>
        <li><a id="ativo" class="header_botao" href="index.html">Home</a></li>
        <li>|</li>
        <li><a class="header_botao" href="cadastro.html">Cadastro</a></li>
        <li><a class="header_botao" href="login.html">Entrar</a></li>
      </ul>
    </div>
  </header>

  <div class="cadastro">

    <div class="container">

      <div class="parte1">
        <h2>Bem vindo(a)!</h2>
        <p>Entre e desfrute de nossa solução</p>
        <button onclick="window.location.href='login.html'">Login</button>
      </div>

      <div class=" card-cadastro">
        <h2>Cadastre-se</h2>

        <div class="formulario">

          <!-- CADASTRO 1 -->
          <div id="cadastro1" class="cadastro1">
            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/empresa.png" alt="">
              </div>
              <input id="razaoSocial" type="text" placeholder="Razão Social" />
              <span id="erro-razao" class="msg-erro">Informe a razão social</span>
            </div>

            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/cnpj.png" alt="">
              </div>
              <input id="cnpj" type="text" placeholder="CNPJ" onblur="pesquisarEmpresa()" />
              <span id="erro-cnpj" class="msg-erro">CNPJ inválido</span>
            </div>

            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/boneco.png" alt="">
              </div>
              <input id="nomeCompleto" type="text" placeholder="Nome" />
              <span id="erro-nome" class="msg-erro">Informe o seu nome completo</span>
            </div>

            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/telefone.png" alt="">
              </div>
              <input id="telefone" type="text" placeholder="Telefone" maxlength="15" />
              <span id="erro-telefone" class="msg-erro">Telefone inválido</span>
            </div>

            <div class="linha-campos">
              <div class="campo" style="position: relative;">
                <div class="desenho">
                  <img src="./assets/imagem/profissao.png" alt="">
                </div>
                <select name="setorUsuario" id="setorUsuario">
                  <option value="setor">Setor</option>
                  <option value="admin">Administração</option>
                  <option value="vendas">Vendas</option>
                  <option value="marketing">Marketing</option>
                  <option value="operacao">Operações</option>
                </select>
                <span id="erro-setor" class="msg-erro">Setor inválido</span>
              </div>
              <div class="campo" style="position: relative;">
                <select name="cargoUsuario" id="cargoUsuario">
                  <option value="cargo">Cargo</option>
                  <option value="1">Gerente de Projetos</option>
                  <option value="2">Analista Financeiro</option>
                  <option value="3">Consultor de Vendas</option>
                  <option value="4">Assistente de Vendas</option>
                  <option value="5">Gerente de Marketing</option>
                  <option value="6">Coordenador de Marketing</option>
                  <option value="7">Analista de Dados</option>
                  <option value="8">Gerente de Produção</option>
                </select>
                <span id="erro-cargo" class="msg-erro">Cargo inválido</span>
              </div>
            </div>

            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/email.png" alt="">
              </div>
              <input id="email_input" type="text" placeholder="Email" />
              <span id="erro-email" class="msg-erro">Digite um email válido</span>
            </div>

            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/cadeado.png" alt="">
              </div>
              <input id="senha_input" type="password" placeholder="Senha" />
              <i id="toggleSenha" class="fa-solid fa-eye" style="position: absolute; right: 10px; top: 45%; transform: translateY(-50%);
                         cursor: pointer; font-size: 18px; color: #ffffff;"></i>
              <span id="erro-senha" class="msg-erro">
                deve ter 8+ caracteres, maiúscula, minúscula, número e símbolo
              </span>
            </div>

            <div class="campo" style="position: relative;">
              <div class="desenho">
                <img src="./assets/imagem/cadeado.png" alt="">
              </div>
              <input id="confirmacao_senha_input" type="password" placeholder="Confirmar Senha" />
              <i id="toggleConfirmacao" class="fa-solid fa-eye" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                    cursor: pointer; font-size: 18px; color: #f4f4f4;">
              </i>

              <span id="erro-confirmar" class="msg-erro">As senhas não coincidem</span>
            </div>

            <div class="indicador">
              <p id="etapa" style="color: #00283a;">Etapa 1 de 2</p>
              <button class="botaoGeral" type="button" onclick="irParaCadastro2()">Próximo</button>
            </div>


          </div>
          <!-- CADASTRO 2 -->
          <div class="cadastro2" style="display:none; width: 100%; flex-direction: column; gap: 10px;">

            <div class="voltar" style="margin-bottom: 10px; cursor: pointer;" onclick="voltarParaCadastro1()">
              <img src="./assets/imagem/seta.png" alt="">
            </div>

            <!-- Linha CEP + UF -->
            <div class="linha-campos">
              <div class="campo">
                <input id="cep" type="text" placeholder="CEP" />
                <span id="erro-cep" class="msg-erro">CEP inválido</span>
              </div>
              <div class="campo">
                <input id="uf" type="text" placeholder="UF" />
              </div>
            </div>

            <div class="campo">
              <input id="cidade" type="text" placeholder="Cidade" />
              <span id="erro-cidade" class="msg-erro">Informe a cidade</span>
            </div>

            <div class="campo">
              <input id="bairro" type="text" placeholder="Bairro" />
              <span id="erro-bairro" class="msg-erro">Informe o bairro</span>
            </div>

            <div class="linha-campos">
              <div class="campo">
                <input id="logradouro" type="text" placeholder="Logradouro" />
              </div>
              <div class="campo">
                <input id="numero" type="text" placeholder="Número" />
              </div>
            </div>

            <div class="campo">
              <input id="complemento" type="text" placeholder="Complemento" />
            </div>

            <div class="botao-final">
              <button class="botaoGeral" type="button" onclick="cadastrar()">Finalizar</button>
            </div>

          </div>

        </div>

      </div>

    </div>

  </div>

  <!--footer inicio-->
  <footer>
    <div>
      <h1>Logaritmos 2025 - TODOS OS DIREITOS RESERVADOS</h1>
    </div>
  </footer>
  <!--footer fim-->

  <script src="./js/validacaoCadastroLogin.js"></script>
</body>

</html>

<script>

  // Voltar para a etapa 1 sem perder dados
  function voltarParaCadastro1() {
    document.querySelector(".cadastro2").style.display = "none";
    document.querySelector(".cadastro1").style.display = "flex";
    document.querySelector(".container").style.height = "90%";
  }

  async function pesquisarEmpresa() {
    var cnpj = document.getElementById("cnpj").value.replace(/\D/g, "");

    if (cnpj.length === 14) {
      try {
        const resposta = await fetch(`/empresa/buscar/${cnpj}`);

        if (resposta.status === 200) {
          const dados = await resposta.json();
          console.log("Empresa encontrada:", dados);

          // Preenchendo campos automaticamente
          document.getElementById("razaoSocial").value = dados.razaoSocial;
          document.getElementById("cep").value = dados.cep;
          document.getElementById("uf").value = dados.estado;
          document.getElementById("cidade").value = dados.cidade;
          document.getElementById("bairro").value = dados.bairro;
          document.getElementById("logradouro").value = dados.logradouro;
          document.getElementById("numero").value = dados.numero;
          if (dados.complemento) {
            document.getElementById("complemento").value = dados.complemento;
          }

          document.getElementById("razaoSocial").disabled = true;
          document.getElementById("cep").disabled = true;
          document.getElementById("uf").disabled = true;
          document.getElementById("cidade").disabled = true;
          document.getElementById("bairro").disabled = true;
          document.getElementById("logradouro").disabled = true;
          document.getElementById("numero").disabled = true;
          if (dados.complemento) {
            document.getElementById("complemento").disabled = true;
          }

          alert("Empresa encontrada! Vincularemos seu cadastro a ela.");
        } else {
          // Se não encontrar (status 204), libera os campos para cadastro novo
          console.log("Empresa não encontrada. Cadastro novo.");
          document.getElementById("razaoSocial").disabled = false;
          document.getElementById("razaoSocial").value = "";
          // Limpar campos de endereço também se quiser
        }

      } catch (erro) {
        console.error("Erro ao buscar empresa:", erro);
      }
    }
  }

  function cadastrar() {
    //empresa
    const razaoVar = document.getElementById("razaoSocial").value.trim();
    const cnpjVar = document.getElementById("cnpj").value.trim().replace(/\D/g, "");
    //usuario
    const nomeVar = document.getElementById("nomeCompleto").value.trim();
    const telefoneVar = document.getElementById("telefone").value.trim();
    const setorVar = document.getElementById("setorUsuario").value.trim();
    const cargoVar = document.getElementById("cargoUsuario").value.trim();
    const emailVar = document.getElementById("email_input").value.trim();
    const senhaVar = document.getElementById("senha_input").value;
    const confirmacao_senhaVar = document.getElementById("confirmacao_senha_input").value;
    //endereco
    const estadoVar = document.getElementById("uf").value.trim();
    const cidadeVar = document.getElementById("cidade").value.trim();
    const bairroVar = document.getElementById("bairro").value.trim();
    const logradouroVar = document.getElementById("logradouro").value.trim();
    const numVar = document.getElementById("numero").value.trim();
    const complementoVar = document.getElementById("complemento") ? document.getElementById("complemento").value.trim() : "";
    const cepVar = document.getElementById("cep").value.trim().replace(/\D/g, "");

    if (validarFormularioEtapa2()) {
      if (!razaoVar || !cnpjVar || !nomeVar || !telefoneVar || !emailVar || !senhaVar || !confirmacao_senhaVar ||
        !estadoVar || !cidadeVar || !bairroVar || !logradouroVar || !numVar || !cepVar) {
        return false;
      }

      if (senhaVar !== confirmacao_senhaVar) {
        return false;
      }

      fetch("/empresa/cadastrar-com-endereco", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          razaoSocialServer: razaoVar,
          cnpjServer: cnpjVar,
          nomeServer: nomeVar,
          telefoneServer: telefoneVar,
          setorServer: setorVar,
          cargoServer: cargoVar,
          emailServer: emailVar,
          senhaServer: senhaVar,
          logradouroServer: logradouroVar,
          numeroServer: numVar,
          complementoServer: complementoVar,
          bairroServer: bairroVar,
          cidadeServer: cidadeVar,
          estadoServer: estadoVar,
          cepServer: cepVar
        })
      })
        .then(response => {
          if (!response.ok) {
            throw new Error("Erro na requisição: " + response.status);
          }
          return response.json();
        })
        .then(data => {
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1000);
        })
        .catch(error => {
          console.error("Erro no cadastro:", error);
        });

      return false;
    }
  }


  function sumirMensagem() {
    cardErro.style.display = "none";
  }


  // --- BOTÕES --- //
  function irParaCadastro2() {
    if (validarFormularioEtapa1()) {
      document.querySelector(".cadastro1").style.display = "none";
      document.querySelector(".cadastro2").style.display = "flex";
      document.querySelector(".container").style.height = "75%";

      document.querySelector(".voltar").style.display = "block";
    }
  }

  const cadastro1 = document.getElementById("cadastro1");



  // Esconder e aparecer senha 
  const senhaInput = document.getElementById("senha_input");
  const toggleSenha = document.getElementById("toggleSenha");

  toggleSenha.addEventListener("click", () => {
    if (senhaInput.type === "password") {
      senhaInput.type = "text";
      toggleSenha.classList.remove("fa-eye");
      toggleSenha.classList.add("fa-eye-slash");
    } else {
      senhaInput.type = "password";
      toggleSenha.classList.remove("fa-eye-slash");
      toggleSenha.classList.add("fa-eye");
    }
  });

  // Esconder e aparecer senha (Confirmacao)
  const confirmacaoInput = document.getElementById("confirmacao_senha_input");
  const toggleConfirmacao = document.getElementById("toggleConfirmacao");

  toggleConfirmacao.addEventListener("click", () => {
    if (confirmacaoInput.type === "password") {
      confirmacaoInput.type = "text";
      toggleConfirmacao.classList.remove("fa-eye");
      toggleConfirmacao.classList.add("fa-eye-slash");
    } else {
      confirmacaoInput.type = "password";
      toggleConfirmacao.classList.remove("fa-eye-slash");
      toggleConfirmacao.classList.add("fa-eye");
    }
  });

</script>