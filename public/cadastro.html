<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Logaritimos | Cadastro</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="./CSS/cadastro.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>

<body onload="listar()">
  <!--Header-->

  <header>
    <div>
      <img src="./assets/imagem/logo.png" alt="">
    </div>
    <div class="links">
      <ul>
        <li><a id="ativo" class="header_botao" href="index.html">Home</a></li>
        <li>|</li>
        <li><a class="header_botao" href="cadastro.html">Cadastro</a></li>
        <li><a class="header_botao" href="login.html">Entrar</a></li>
      </ul>
    </div>
  </header>

  <div class="cadastro">

    <div class="container">

      <div class="parte1">
        <h2>Bem vindo(a)!</h2>
        <p>Entre e desfrute de nossa solução</p>
        <button><a href="login.html">Login</a></button>
      </div>

      <div class=" card-cadastro">
        <h2>Cadastre-se</h2>

        <div class="formulario">

          <!-- CADASTRO 1 -->
          <div class="cadastro1">
            <div class="campo">
              <input id="razaoSocial" type="text" placeholder="Razão Social" />
              <span id="erro-razao" class="msg-erro">Informe a razão social</span>
            </div>

            <div class="campo">
              <input id="cnpj" type="text" placeholder="CNPJ" />
              <span id="erro-cnpj" class="msg-erro">CNPJ inválido</span>
            </div>

            <div class="campo">
              <input id="email_input" type="text" placeholder="Email" />
              <span id="erro-email" class="msg-erro">Digite um email válido</span>
            </div>

            <div class="campo" style="position: relative;">
              <input id="senha_input" type="password" placeholder="Senha" />
              <i id="toggleSenha" class="fa-solid fa-eye-slash" style="position: absolute; right: 5px; top: 45%; transform: translateY(-50%);
                         cursor: pointer; font-size: 18px; color: #555;"></i>
              <span id="erro-senha" class="msg-erro">
                A senha deve ter 8+ caracteres, maiúscula, minúscula, número e símbolo
              </span>
            </div>

            <div class="campo" style="position: relative;">
                 <input id="confirmacao_senha_input" type="password" placeholder="Confirmar Senha" />
                 <i id="toggleConfirmacao" class="fa-solid fa-eye-slash" 
                   style="position: absolute; right: 5px; top: 45%; transform: translateY(-50%);
                    cursor: pointer; font-size: 18px; color: #555;">
                 </i>
              
              <span id="erro-confirmar" class="msg-erro">As senhas não coincidem</span>
            </div>

            <div class="indicador">
              <p id="etapa" style="color: #00283a;">Etapa 1 de 2</p>
               <button class="botaoGeral" type="button" onclick="irParaCadastro2()">Próximo</button>
            </div>


          </div>
          <!-- CADASTRO 2 -->
          <div class="cadastro2" style="display:none; width: 100%; flex-direction: column;">
  
  <div class="voltar" style="margin-bottom: 10px; cursor: pointer;"></div>

  <!-- Linha CEP + UF -->
  <div class="linha-campos">
    <div class="campo">
      <input id="cep" type="text" placeholder="CEP" />
      <span id="erro-cep" class="msg-erro">CEP inválido</span>
    </div>
    <div class="campo">
      <input id="uf" type="text" placeholder="UF" />
    </div>
  </div>

  <div class="campo">
    <input id="cidade" type="text" placeholder="Cidade" />
    <span id="erro-cidade" class="msg-erro">Informe a cidade</span>
  </div>

  <div class="campo">
    <input id="bairro" type="text" placeholder="Bairro" />
    <span id="erro-bairro" class="msg-erro">Informe o bairro</span>
  </div>

  <div class="linha-campos">
    <div class="campo">
      <input id="logradouro" type="text" placeholder="Logradouro" />
    </div>
    <div class="campo">
      <input id="numero" type="text" placeholder="Número" />
    </div>
  </div>

  <div class="campo">
    <input id="complemento" type="text" placeholder="Complemento" />
  </div>

  <div class="botao-final">
    <button class="botaoGeral" type="button" onclick="finalizarCadastro()">Finalizar</button>
  </div>
  
</div>



        </div>

      </div>

    </div>

  </div>

  <!--footer inicio-->
  <footer>
    <div>
      <h1>Logaritmo 2025 - TODOS OS DIREITOS RESERVADOS</h1>
    </div>
  </footer>
  <!--footer fim-->

  <script src="./js/validacaoCadastroLogin.js"></script>
</body>

</html>

<script>



  // Array para armazenar empresas cadastradas para validação de código de ativação 
  let listaEmpresasCadastradas = [];

  // Voltar para a etapa 1 sem perder dados
  function voltarParaCadastro1() {
    document.querySelector(".cadastro2").style.display = "none";
    document.querySelector(".cadastro1").style.display = "flex";
  }

  function cadastrar() {
    // aguardar();

    // Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = nome_input.value;
    var emailVar = email_input.value;
    var senhaVar = senha_input.value;
    var confirmacaoSenhaVar = confirmacao_senha_input.value;
    var codigoVar = codigo_input.value;
    var idEmpresaVincular

    // Verificando se há algum campo em branco
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      codigoVar == ""
    ) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "(Mensagem de erro para todos os campos em branco)";

      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    // Verificando se o código de ativação é de alguma empresa cadastrada
    for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
      if (listaEmpresasCadastradas[i].codigo_ativacao == codigoVar) {
        idEmpresaVincular = listaEmpresasCadastradas[i].id
        console.log("Código de ativação válido.");
        break;
      } else {
        cardErro.style.display = "block";
        mensagem_erro.innerHTML = "(Mensagem de erro para código inválido)";
        finalizarAguardar();
      }
    }

    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        nomeServer: nomeVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        idEmpresaVincularServer: idEmpresaVincular
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          cardErro.style.display = "block";

          mensagem_erro.innerHTML =
            "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

          setTimeout(() => {
            window.location = "login.html";
          }, "2000");

          limparFormulario();
          finalizarAguardar();
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    return false;
  }

  // Listando empresas cadastradas 
  function listar() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);

            console.log("listaEmpresasCadastradas")
            console.log(listaEmpresasCadastradas[0].codigo_ativacao)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function sumirMensagem() {
    cardErro.style.display = "none";
  }





  // --- BOTÕES --- //
  function irParaCadastro2() {
    if (validarFormularioEtapa1()) {
      document.querySelector(".cadastro1").style.display = "none";
      document.querySelector(".cadastro2").style.display = "block";

      document.querySelector(".voltar").style.display = "block";
    }
  }


  // Esconder e aparecer senha 
  const senhaInput = document.getElementById("senha_input");
  const toggleSenha = document.getElementById("toggleSenha");

  toggleSenha.addEventListener("click", () => {
    if (senhaInput.type === "password") {
      senhaInput.type = "text";
      toggleSenha.classList.remove("fa-eye-slash");
      toggleSenha.classList.add("fa-eye");
    } else {
      senhaInput.type = "password";
      toggleSenha.classList.remove("fa-eye");
      toggleSenha.classList.add("fa-eye-slash");
    }
  });

  // Esconder e aparecer senha (Confirmacao)
  const confirmacaoInput = document.getElementById("confirmacao_senha_input");
  const toggleConfirmacao = document.getElementById("toggleConfirmacao");

  toggleConfirmacao.addEventListener("click", () => {
    if (confirmacaoInput.type === "password") {
      confirmacaoInput.type = "text";
      toggleConfirmacao.classList.remove("fa-eye-slash");
      toggleConfirmacao.classList.add("fa-eye");
    } else {
      confirmacaoInput.type = "password";
      toggleConfirmacao.classList.remove("fa-eye");
      toggleConfirmacao.classList.add("fa-eye-slash");
    }
  });

  function finalizarCadastro() {
    if (validarFormularioEtapa2()) {
      alert("Cadastro efetuado com sucesso!");

      setTimeout(() => {
        window.location.href = "login.html";
      }, 100);
    }
  }

</script>