<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logaritmos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./CSS/dashboard.css">
    <link rel="stylesheet" href="./CSS/util.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <!--Header-->
    <header>
        <div>
            <img src="./assets/imagem/logo.png" alt="">
        </div>
    </header>

    <!--Sidebar-->

       <div class="sidebar">
        <!-- Informações -->
        <a href="info.html">
            <i class="fa-solid fa-user"></i>
        </a>

        <!-- Dashboard -->
        <a href="dashboard.html" class="active">
            <i class="fa-solid fa-clock"></i>
        </a>

        <!-- Angular -->
        <a id="link-angular" href="#"><i class="fa-solid fa-envelope"></i></a>

        <!-- Comparativos -->
        <a href="comparativos.html">
            <i class="fa-solid fa-file-lines"></i>
        </a>

        <!-- Configurações -->
        <a href="configuracoes.html">
            <i class="fa-solid fa-gear"></i>
        </a>

        <a href="slack.html"><img src="./assets/imagem/logoslack.png" alt="" class="logoSlack" ></a>

        <!-- Logout -->
        <a href="#" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i>
        </a>
    </div>


    <h2 class="titulo">Dashboard</h2>
    <div class="fundo">


        <div class="dashboard-container">

            <div class="top-cards">
                <div class="card">
                    <div class="icon-square">
                        <i class="fa-solid fa-plane"></i>
                    </div>
                    <div class="card-content">
                        <h3>Taxa de Crescimento de Voos em relação aos últimos 3 anos</h3>
                        <p id="KPI1">
                            <i class="fa-solid fa-arrow-up"></i>
                        </p>

                    </div>
                </div>

                <div class="card">
                    <div class="icon-square">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div class="card-content">
                        <h3>Relação de variação entre o numero de embarques e número de voos totais</h3>
                        <p id="KPI2"></p>
                    </div>
                </div>

                <div class="card">
                    <div class="icon-square">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div class="card-content">
                        <h3>Estado com menor taxa de crescimento de voos nos últimos 3 anos</h3>
                        <p id="KPI3"></p>
                    </div>
                </div>

                <div class="card">
                    <div class="icon-square">
                        <i class="fa-solid fa-map-location"></i>
                    </div>
                    <div class="card-content">
                        <h3>Estado com maior taxa de crescimento de voos nos últimos 3 anos</h3>
                        <p id="KPI4"></p>
                    </div>
                </div>
            </div>


            <div class="main-content">
                <div class="charts-container">
                    <div class="chart-wrapper"
                        style="flex: 1; background-color: #001A27; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; margin-bottom: 10px;">
                        <h4 class="chart-title">Quantidade de Passageiros por Voos Anualmente</h4>
                        <div class="chart" style="position: relative; height: 100%; width: 100%;">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-wrapper"
                        style="flex: 1; background-color: #001A27; border-radius: 8px; padding: 10px; display: flex; flex-direction: column;">
                        <h4 class="chart-title">Tráfego de Passageiros por Mês</h4>
                        <div class="chart" style="position: relative; height: 100%; width: 100%;">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="table-section">
                    <h4 class="table-title">Ranking de Destinos Nacionais </h4>
                    <br>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Destinos</th>
                                    <th>Embarque</th>
                                    <th>Desembarque</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                        <div class="pagination" id="pagination"></div>
                    </div>
                </div>
            </div>



        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function logout() {
            sessionStorage.clear();
            window.location.href = '../../login.html';
        }

        let graficoLinha;
        let graficoBarra;

        // --- Gráfico (1) linha ---
        function obterDadosGraficoAnual() {
            fetch(`/voo/anuais`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            plotarGraficoLinha(dados);
                        });
                    } else {
                        console.error('Erro na API (Anual):', resposta.status, resposta.statusText);
                        resposta.text().then(texto => console.error("Texto do erro:", texto));
                    }
                })
                .catch(erro => console.error('Erro CRÍTICO na requisição (Anual):', erro));
        }
        function plotarGraficoLinha(dados) {
            const ctxLine = document.getElementById('lineChart').getContext('2d');

            const labelsAno = dados.map(dado => dado.ano);
            const dadosPassageiros = dados.map(dado => dado.total);

            graficoLinha = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labelsAno,
                    datasets: [{
                        label: 'Passageiros Totais',
                        data: dadosPassageiros,
                        borderColor: '#D9D9D9',
                        backgroundColor: '#001A27',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { ticks: { color: '#fff' } },
                        y: { ticks: { color: '#fff' } }
                    }
                }
            });
        }

        // --- Gráfico (2) barra ---
        function obterDadosGraficoMensal() {
            fetch(`/voo/mensais`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            plotarGraficoBarra(dados);
                        });
                    } else {
                        console.error('Erro na API (Mensal):', resposta.status, resposta.statusText);
                        resposta.text().then(texto => console.error("Texto do erro:", texto));
                    }
                })
                .catch(erro => console.error('Erro CRÍTICO na requisição (Mensal):', erro));
        }
        function plotarGraficoBarra(dados) {
            const ctxBar = document.getElementById('barChart').getContext('2d');

            const labelsMes = dados.map(dado => dado.mes);
            const dadosPassageiros = dados.map(dado => dado.total);

            graficoBarra = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labelsMes,
                    datasets: [{
                        label: 'Passageiros',
                        data: dadosPassageiros,
                        backgroundColor: '#D9D9D9'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { ticks: { color: '#fff' } },
                        y: { ticks: { color: '#fff' } }
                    }
                }
            });
        }

        // --- Paginação do Ranking de Destinos ---
        let listaDestinos = [];
        const rowsPerPage = 9;
        let currentPage = 1;

        function obterDadosTabela() {
            fetch(`/voo/destinos`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            listaDestinos = dados;
                            renderTable(currentPage);
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                    }
                })
                .catch(erro => console.error('Erro na requisição:', erro));
        }

        const tableBody = document.getElementById('table-body');
        const pagination = document.getElementById('pagination');

        function renderTable(page) {
            tableBody.innerHTML = '';

            const totalPages = Math.ceil(listaDestinos.length / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            const paginatedItems = listaDestinos.slice(start, end);

            paginatedItems.forEach(d => {
                const tr = document.createElement('tr');

                const embAtual = Number(d.embarqueAtual);
                const embAnt = Number(d.embarqueAnterior);
                const desAtual = Number(d.desembarqueAtual);
                const desAnt = Number(d.desembarqueAnterior);

                const embarqueFormatado = embAtual.toLocaleString('pt-BR');
                const desembarqueFormatado = desAtual.toLocaleString('pt-BR');

                const htmlVarEmbarque = calcularVariacao(embAtual, embAnt);
                const htmlVarDesembarque = calcularVariacao(desAtual, desAnt);

                tr.innerHTML = `
                <td>${d.nome}</td>
                <td>
                    ${embarqueFormatado} 
                    ${htmlVarEmbarque}
                </td>
                <td>
                    ${desembarqueFormatado}
                    ${htmlVarDesembarque}
                </td>
            `;
                tableBody.appendChild(tr);
            });

            renderPagination(totalPages);
        }
        function calcularVariacao(atual, anterior) {
            // Não tinha dados no ano anterior (Novo destino)
            if (anterior === 0) {
                return atual > 0
                    ? '<span class="variacao variacao-positiva"><i class="fa-solid fa-arrow-up"></i> Novo</span>'
                    : '<span class="variacao variacao-neutra">-</span>';
            }

            const diferenca = atual - anterior;
            const porcentagem = (diferenca / anterior) * 100;

            const porcentagemAbsoluta = Math.abs(porcentagem);
            const valorFormatado = porcentagemAbsoluta.toFixed(1).replace('.', ',');

            if (porcentagem > 0) {
                return `<span class="variacao variacao-positiva">
                        <i class="fa-solid fa-arrow-up"></i> ${valorFormatado}%
                    </span>`;
            } else if (porcentagem < 0) {
                return `<span class="variacao variacao-negativa">
                        <i class="fa-solid fa-arrow-down"></i> ${valorFormatado}%
                    </span>`;
            } else {
                return '<span class="variacao variacao-neutra">0%</span>';
            }
        }

        function renderPagination(totalPages) {
            pagination.innerHTML = '';

            const prev = document.createElement('button');
            prev.textContent = '<';
            prev.disabled = currentPage === 1;
            prev.onclick = () => { currentPage--; renderTable(currentPage); };
            pagination.appendChild(prev);

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                if (i === currentPage) btn.classList.add('active');
                btn.onclick = () => { currentPage = i; renderTable(currentPage); };
                pagination.appendChild(btn);
            }

            const next = document.createElement('button');
            next.textContent = '>';
            next.disabled = currentPage === totalPages || totalPages === 0;
            next.onclick = () => { currentPage++; renderTable(currentPage); };
            pagination.appendChild(next);
        }

        // ----- Funções para Criar KPIS -----
        function obterKPI1() {
            console.log("Função obterKPI1 foi chamada");
            fetch(`/voo/KPI1`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            const dado2019 = dados.find(d => d.ano === 2019);
                            const dado2021 = dados.find(d => d.ano === 2021);

                            if (!dado2019 || !dado2021) {
                                console.error('Dados para os anos 2019 ou 2021 não encontrados');
                                return;
                            }
                            const valorInicial = Number(dado2019.totalVoos);
                            const valorFinal = Number(dado2021.totalVoos);
                            const taxaVoos = Number(((Math.pow(valorFinal / valorInicial, 1 / 3) - 1) * 100).toFixed(2));
                            let setaHTML = '';
                            if (taxaVoos >= 0) {
                                setaHTML = '<i class="fa-solid fa-arrow-up"></i>';
                                document.getElementById('KPI1').innerHTML = `${setaHTML}${taxaVoos}%`;
                            } else {
                                setaHTML = '<i class="fa-solid fa-arrow-down"></i>';
                                document.getElementById('KPI1').innerHTML = `${setaHTML}${taxaVoos}%`;
                            }

                            const variacaoVoos = Number(Math.pow(valorFinal / valorInicial, 1 / 3) - 1);
                            obterKPI2(variacaoVoos);

                        });
                    } else {
                        console.error('Erro na API (KPI1):', resposta.status, resposta.statusText);
                        resposta.text().then(texto => console.error("Texto do erro:", texto));
                    }
                })
                .catch(erro => console.error('Erro CRÍTICO na requisição (KPI1):', erro));
        }

        function obterKPI2(variacaoVoos) {
            console.log("Função obterKPI2 foi chamada");
            fetch(`/voo/KPI2`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            const dado2019 = dados.find(d => d.ano === 2019);
                            const dado2021 = dados.find(d => d.ano === 2021);

                            if (!dado2019 || !dado2021) {
                                console.error('Dados para os anos 2019 ou 2021 não encontrados');
                                return;
                            }
                            const valorInicial = Number(dado2019.totalEmbarques);
                            const valorFinal = Number(dado2021.totalEmbarques);
                            const variacaoEmbarques = Number(Math.pow(valorFinal / valorInicial, 1 / 3) - 1);
                            const elasticidadeDemanda = Number((variacaoEmbarques / variacaoVoos).toFixed(2));
                            document.getElementById('KPI2').textContent = `${elasticidadeDemanda}`;
                        });
                    } else {
                        console.error('Erro na API (KPI2):', resposta.status, resposta.statusText);
                        resposta.text().then(texto => console.error("Texto do erro:", texto));
                    }
                })
                .catch(erro => console.error('Erro CRÍTICO na requisição (KPI2):', erro));
        }

        function obterKPI3() {
            console.log("Função obterKPI3 foi chamada");
            fetch(`/voo/KPI3`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            document.getElementById('KPI3').textContent = dados[0].estado;
                        });
                    } else {
                        console.error('Erro na API (KPI3):', resposta.status, resposta.statusText);
                        resposta.text().then(texto => console.error("Texto do erro:", texto));
                    }
                })
                .catch(erro => console.error('Erro CRÍTICO na requisição (KPI3):', erro));
        }

        function obterKPI4() {
            console.log("Função obterKPI4 foi chamada");
            fetch(`/voo/KPI4`)
                .then(resposta => {
                    if (resposta.ok) {
                        resposta.json().then(dados => {
                            console.log(JSON.stringify(dados))
                            document.getElementById('KPI4').textContent = dados[0].estado;
                        });
                    } else {
                        console.error('Erro na API (KPI4):', resposta.status, resposta.statusText);
                        resposta.text().then(texto => console.error("Texto do erro:", texto));
                    }
                })
                .catch(erro => console.error('Erro CRÍTICO na requisição (KPI4):', erro));
        }

        window.onload = function () {
            console.log("window.onload executado 2");
            obterDadosGraficoAnual();
            obterDadosGraficoMensal();
            obterDadosTabela();
            obterKPI1();
            obterKPI3();
            obterKPI4();
        };

    </script>
    <script src="./js/link.js"></script>
</body>

</html>