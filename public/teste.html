<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Logaritimos | Cadastro</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="./CSS/teste.css" />
</head>

<body onload="listar()">
  <!--Header-->

  <header>
    <div>
      <img src="./assets/imagem/logo.png" alt="">
    </div>
    <div class="links">
      <ul>
        <li><a id="ativo" class="header_botao" href="index.html">Home</a></li>
        <li>|</li>
        <li><a class="header_botao" href="cadastro.html">Cadastro</a></li>
        <li><a class="header_botao" href="login.html">Entrar</a></li>
      </ul>
    </div>
  </header>

  <div class="cadastro">

    <div class="container">
        
        <div class="parte1">
            <h2>Boas Vindas!</h2>
            <p>Entre e desfrute de nossa solução</p>
            <button><a href="login.html">Login</a></button>
        </div>

        <div class="card card-cadastro">
            <h2>Bem-vindo!</h2>

            <div class="formulario">
                
                <!-- CADASTRO 1 -->
                <div class="cadastro1">
                    <div class="campo">
                        <input id="razaoSocial" type="text" placeholder="Razão Social" />
                        <span id="erro-razao" class="msg-erro">Informe a razão social</span>
                    </div>

                    <div class="campo">
                      <input id="cnpj" type="text" placeholder="CNPJ" />
                       <span id="erro-cnpj" class="msg-erro">CNPJ inválido</span>
                    </div>

                    <div class="campo">
                      <input id="email_input" type="text" placeholder="Email" />
                      <span id="erro-email" class="msg-erro">Digite um email válido</span>
                    </div>

                    <div class="campo">
                      <input id="senha_input" type="password" placeholder="Senha" />
                      <span id="erro-senha" class="msg-erro">
                        A senha deve ter 8+ caracteres, maiúscula, minúscula, número e símbolo
                      </span>
                    </div>

                    <div class="campo">
                      <input id="confirmacao_senha_input" type="password" placeholder="Confirmar Senha" />
                      <span id="erro-confirmar" class="msg-erro">As senhas não coincidem</span>
                    </div>

                    <div class="indicador">
                      <p id="etapa">Etapa 1 de 2</p>
                      <span id="erro-cep" class="msg-erro">CEP inválido</span>
                    </div>

                    <div>
                        <button class="botaoGeral" type="button" onclick="irParaCadastro2()">Próximo</button>
                    </div>

                </div>
                <!-- CADASTRO 2 -->
                <div class="cadastro2" style="display:none;">
                    
                    <div class="campo">
                      <input id="cep" type="text" placeholder="CEP" />
                      <input id="uf" type="text" placeholder="UF" />
                    </div>
                    
                    <div class="campo">
                      <input id="cidade" type="text" placeholder="Cidade" />
                      <span id="erro-cidade" class="msg-erro">Informe a cidade</span>
                    </div>
                
                    <div class="campo">
                        <input id="bairro" type="text" placeholder="Bairro" />
                        <span id="erro-bairro" class="msg-erro">Informe o bairro</span>
                    </div>

                    <div class="campo">
                       <input id="logradouro" type="text" placeholder="Logradouro" />
                       <input id="numero" type="text" placeholder="Número" />
                    </div>

                    <div class="campo">
                      <input id="complemento" type="text" placeholder="Complemento" />
                    </div>

                     <div>
                       <button class="botaoGeral" type="button" onclick="cadastrar()">Finalizar</button>
                    </div>
                </div>

                
            </div>

         </div>

    </div>,
    
</div>
    
<!--footer inicio-->
        <footer>
          <div>
            <h1>Logaritmo 2025 - TODOS OS DIREITOS RESERVADOS</h1>
          </div>
        </footer>
<!--footer fim-->
</body>
</html>

<script>



  // Array para armazenar empresas cadastradas para validação de código de ativação 
  let listaEmpresasCadastradas = [];

  function cadastrar() {
    // aguardar();

    // Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = nome_input.value;
    var emailVar = email_input.value;
    var senhaVar = senha_input.value;
    var confirmacaoSenhaVar = confirmacao_senha_input.value;
    var codigoVar = codigo_input.value;
    var idEmpresaVincular

    // Verificando se há algum campo em branco
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      codigoVar == ""
    ) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "(Mensagem de erro para todos os campos em branco)";

      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    // Verificando se o código de ativação é de alguma empresa cadastrada
    for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
      if (listaEmpresasCadastradas[i].codigo_ativacao == codigoVar) {
        idEmpresaVincular = listaEmpresasCadastradas[i].id
        console.log("Código de ativação válido.");
        break;
      } else {
        cardErro.style.display = "block";
        mensagem_erro.innerHTML = "(Mensagem de erro para código inválido)";
        finalizarAguardar();
      }
    }

    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        nomeServer: nomeVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        idEmpresaVincularServer: idEmpresaVincular
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          cardErro.style.display = "block";

          mensagem_erro.innerHTML =
            "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

          setTimeout(() => {
            window.location = "login.html";
          }, "2000");

          limparFormulario();
          finalizarAguardar();
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    return false;
  }

  // Listando empresas cadastradas 
  function listar() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);

            console.log("listaEmpresasCadastradas")
            console.log(listaEmpresasCadastradas[0].codigo_ativacao)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function sumirMensagem() {
    cardErro.style.display = "none";
  }










// --- MÁSCARAS --- //
function aplicarMascaraCNPJ(campo) {
  campo.value = campo.value.replace(/\D/g, "")
    .replace(/^(\d{2})(\d)/, "$1.$2")
    .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3")
    .replace(/\.(\d{3})(\d)/, ".$1/$2")
    .replace(/(\d{4})(\d)/, "$1-$2")
    .slice(0, 18);
}

function aplicarMascaraCEP(campo) {
  campo.value = campo.value.replace(/\D/g, "")
    .replace(/^(\d{5})(\d)/, "$1-$2")
    .slice(0, 9);
}

function aplicarMascaraUF(campo) {
  campo.value = campo.value.replace(/[^a-zA-Z]/g, "").toUpperCase().slice(0, 2);
}

function aplicarMascaraNumero(campo) {
  campo.value = campo.value.replace(/\D/g, "");
}

// --- VALIDAÇÕES --- //
function validarEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validarSenha(senha) {
  return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(senha);
}

// Funções de erro visual
function mostrarErro(inputId, erroId) {
  document.getElementById(inputId).classList.add("erro");
  document.getElementById(erroId).style.display = "block";
}

function removerErro(inputId, erroId) {
  document.getElementById(inputId).classList.remove("erro");
  document.getElementById(erroId).style.display = "none";
}

function validarFormularioEtapa1() {
  let valido = true;

  // Razão Social
  if (razaoSocial.value.trim() === "") {
    mostrarErro("razaoSocial", "erro-razao");
    valido = false;
  } else {
    removerErro("razaoSocial", "erro-razao");
  }

  // CNPJ
  if (cnpj.value.trim().length !== 18) {
    mostrarErro("cnpj", "erro-cnpj");
    valido = false;
  } else {
    removerErro("cnpj", "erro-cnpj");
  }

  // Email
  if (!validarEmail(email_input.value)) {
    mostrarErro("email_input", "erro-email");
    valido = false;
  } else {
    removerErro("email_input", "erro-email");
  }

  // Senha
  if (!validarSenha(senha_input.value)) {
    mostrarErro("senha_input", "erro-senha");
    valido = false;
  } else {
    removerErro("senha_input", "erro-senha");
  }

  // Confirmar Senha
  if (senha_input.value !== confirmacao_senha_input.value || confirmacao_senha_input.value === "") {
    mostrarErro("confirmacao_senha_input", "erro-confirmar");
    valido = false;
  } else {
    removerErro("confirmacao_senha_input", "erro-confirmar");
  }

  return valido;
}

function validarFormularioEtapa2() {
  let valido = true;

  // CEP
  if (cep.value.trim().length !== 9) {
    cep.classList.add("erro");
    valido = false;
  } else {
    cep.classList.remove("erro");
  }

  // UF
  if (uf.value.trim().length !== 2) {
    uf.classList.add("erro");
    valido = false;
  } else {
    uf.classList.remove("erro");
  }

  // Cidade
  if (cidade.value.trim() === "") {
    cidade.classList.add("erro");
    valido = false;
  } else {
    cidade.classList.remove("erro");
  }

  // Bairro
  if (bairro.value.trim() === "") {
    bairro.classList.add("erro");
    valido = false;
  } else {
    bairro.classList.remove("erro");
  }

  // Logradouro
  if (logradouro.value.trim() === "") {
    logradouro.classList.add("erro");
    valido = false;
  } else {
    logradouro.classList.remove("erro");
  }

  // Número
  if (numero.value.trim() === "") {
    numero.classList.add("erro");
    valido = false;
  } else {
    numero.classList.remove("erro");
  }

  return valido;
}


// --- BOTÕES --- //
function irParaCadastro2() {
  if (validarFormularioEtapa1()) {
    document.querySelector(".cadastro1").style.display = "none";
    document.querySelector(".cadastro2").style.display = "block";
  }
}

function cadastrar() {
  if (validarFormularioEtapa2()) {
    alert("Cadastro finalizado com sucesso!");
    // aqui você mantém o fetch() do seu back-end
  }
}

// --- APLICANDO MÁSCARAS --- //
document.getElementById("cnpj").addEventListener("input", function() {
  aplicarMascaraCNPJ(this);
});
document.getElementById("cep").addEventListener("input", function() {
  aplicarMascaraCEP(this);
});
document.getElementById("uf").addEventListener("input", function() {
  aplicarMascaraUF(this);
});
document.getElementById("numero").addEventListener("input", function() {
  aplicarMascaraNumero(this);
});
</script>