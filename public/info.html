<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./CSS/util.css">
    <link rel="stylesheet" href="./CSS/info.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <title>Logaritmos</title>
</head>

<body>

    <header>
        <div>
            <img src="./assets/imagem/logo.png" alt="">
        </div>
    </header>

    <div class="sidebar">
        <a href="info.html" class="active"><i class="fa-solid fa-user"></i></a>
        <a href="dashboard.html"><i class="fa-solid fa-clock"></i></a>
          <a id="link-angular" href="#"><i class="fa-solid fa-envelope"></i></a>
        <a href="comparativos.html"><i class="fa-solid fa-file-lines"></i></a>
        <a href="configuracoes.html"><i class="fa-solid fa-gear"></i></a>
        <a href="#" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>

    <div class="container"></div>
    <div class="title">Informações Pessoais</div>

    <div class="form-info">
        <div class="coluna-esq">
            <div class="info-pessoal">
                <label for="razaoSocial">Razão Social</label>
                <input type="text" id="razaoSocial" placeholder="Razão Social" disabled>
                <span id="erro-razao" class="msg-erro">Informe a razão social</span>
            </div>

            <div class="info-pessoal">
                <label for="nome">Nome</label>
                <input type="text" id="nomeCompleto" placeholder="Nome" disabled>
                <span id="erro-nome" class="msg-erro">Informe o seu nome completo</span>
            </div>

            <div class="info-pessoal">
                <label for="setor">Setor</label>
                <select id="setorUsuario" disabled>
                    <option value="0">Selecione</option>
                    <option value="1">Administração</option>
                    <option value="2">Vendas</option>
                    <option value="3">Marketing</option>
                    <option value="4">Operações</option>
                </select>
                <span id="erro-setor" class="msg-erro">Selecione um setor válido</span>
            </div>

            <div class="info-pessoal">
                <label for="CEP">CEP</label>
                <input class="inputs" type="text" id="cep" placeholder="CEP" maxlength="9" disabled>
                <span id="erro-cep" class="msg-erro">CEP inválido</span>
            </div>

            <div class="info-pessoal">
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" placeholder="Cidade" disabled>
                <span id="erro-cidade" class="msg-erro">Informe a cidade</span>
            </div>

        </div>

        <div class="coluna-meio">

            <div class="info-pessoal">
                <label for="CNPJ">CNPJ</label>
                <input type="text" id="cnpj" placeholder="CNPJ" maxlength="18" disabled>
                <span id="erro-cnpj" class="msg-erro">CNPJ inválido</span>
            </div>

            <div class="info-pessoal">
                <label for="telefone">Telefone</label>
                <input type="text" id="telefone" placeholder="Telefone" maxlength="15" disabled>
                <span id="erro-telefone" class="msg-erro">Telefone inválido</span>
            </div>

            <div class="info-pessoal">
                <label for="cargo">Cargo</label>
                <select id="cargoUsuario" disabled>
                    <option value="0">Selecione</option>
                    <option value="1">Gerente de Projetos</option>
                    <option value="2">Analista Financeiro</option>
                    <option value="3">Consultor de Vendas</option>
                    <option value="4">Assistente de Vendas</option>
                    <option value="5">Gerente de Marketing</option>
                    <option value="6">Coordenador de Marketing</option>
                    <option value="7">Analista de Dados</option>
                    <option value="8">Gerente de Produção</option>
                </select>
                <span id="erro-cargo" class="msg-erro">Selecione um cargo válido</span>
            </div>
            
            <div class="info-pessoal">
                <label for="UF">UF</label>
                <select id="uf" disabled>
                    <option value="0">Selecione</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amapá</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Ceará</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Espírito Santo</option>
                    <option value="GO">Goiás</option>
                    <option value="MA">Maranhão</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Pará</option>
                    <option value="PB">Paraíba</option>
                    <option value="PR">Paraná</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piauí</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rondônia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">São Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                </select>
                <span id="erro-uf" class="msg-erro">Selecione uma UF válida</span>
            </div>

            <div class="info-pessoal">
                <label for="Bairro">Bairro</label>
                <input type="text" id="bairro" placeholder="Bairro" disabled>
                <span id="erro-bairro" class="msg-erro">Informe o bairro</span>
            </div>

        </div>

        <div class="coluna-dir">

            <div class="info-pessoal">
                <label for="logradouro">Logradouro</label>
                <input type="text" id="logradouro" placeholder="Logradouro" disabled>
                <span id="erro-logradouro" class="msg-erro">Informe o logradouro</span>
            </div>

            <div class="info-pessoal">
                <label for="numero">Número</label>
                <input type="text" id="numero" placeholder="Número" disabled>
                <span id="erro-numero" class="msg-erro">Informe o número</span>
            </div>

            <div class="info-pessoal">
                <label for="complemento">Complemento</label>
                <input type="text" id="complemento" placeholder="Complemento" disabled>
                <span id="erro-complemento" class="msg-erro">Informe o complemento</span>
            </div>

            <div class="acoes-form">
                <button class="botao-editar" id="btnEditar" onclick="habilitarEdicao()">Editar</button>
                <button class="botao-atualizar" id="btnAtualizar" onclick="atualizar()">Atualizar</button>
            </div>

        </div>
    </div>
</body>
</html>

<script>
    // --- 1. MÁSCARAS ---
    const formatarCNPJ = (v) => v.replace(/\D/g, "").replace(/^(\d{2})(\d)/, "$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3").replace(/\.(\d{3})(\d)/, ".$1/$2").replace(/(\d{4})(\d)/, "$1-$2").slice(0, 18);
    const formatarTelefone = (v) => v.replace(/\D/g, "").replace(/^(\d{2})(\d)/, "($1) $2").replace(/(\d{5})(\d{4})$/, "$1-$2").slice(0, 15);
    const formatarCEP = (v) => v.replace(/\D/g, "").replace(/^(\d{5})(\d)/, "$1-$2").slice(0, 9);
    const formatarNumero = (v) => v.replace(/\D/g, ""); // Apenas números

    document.getElementById('cnpj').addEventListener('input', e => e.target.value = formatarCNPJ(e.target.value));
    document.getElementById('telefone').addEventListener('input', e => e.target.value = formatarTelefone(e.target.value));
    document.getElementById('cep').addEventListener('input', e => e.target.value = formatarCEP(e.target.value));
    document.getElementById('numero').addEventListener('input', e => e.target.value = formatarNumero(e.target.value));

    // Variável para guardar o ID da empresa vindo do banco
    let idEmpresaGlobal = null;

    // --- 2. CARREGAR DADOS ---
    window.onload = function() {
        const idUsuario = sessionStorage.ID_USUARIO;
        if(!idUsuario) {
            alert("Sessão inválida.");
            return window.location.href = '../../login.html';
        }

        fetch(`/empresa/info/${idUsuario}`)
            .then(res => res.json())
            .then(dados => {
                // Salva ID da empresa
                if(dados.idEmpresa) {
                    idEmpresaGlobal = dados.idEmpresa;
                    sessionStorage.ID_EMPRESA = dados.idEmpresa;
                }

                // Preenche campos
                document.getElementById('razaoSocial').value = dados.razaoSocial || '';
                document.getElementById('nomeCompleto').value = dados.nomeUsuario || '';
                document.getElementById('setorUsuario').value = dados.idSetor || '0';
                document.getElementById('cargoUsuario').value = dados.idCargo || '0';
                document.getElementById('cidade').value = dados.cidade || '';
                document.getElementById('logradouro').value = dados.logradouro || '';
                document.getElementById('bairro').value = dados.bairro || '';
                document.getElementById('uf').value = dados.uf || '0';
                document.getElementById('complemento').value = dados.complemento || '';
                document.getElementById('numero').value = dados.numero || '';

                // Aplica formatação visual nos dados vindos do banco
                if(dados.cnpj) document.getElementById('cnpj').value = formatarCNPJ(dados.cnpj);
                if(dados.telefone) document.getElementById('telefone').value = formatarTelefone(dados.telefone);
                if(dados.cep) document.getElementById('cep').value = formatarCEP(dados.cep);
            })
            .catch(err => console.error("Erro ao carregar dados:", err));
    };

    // --- 3. HABILITAR EDIÇÃO ---
    function habilitarEdicao() {
        // Destrava todos os inputs e selects
        const inputs = document.querySelectorAll('.form-info input, .form-info select');
        inputs.forEach(input => input.disabled = false);
        
        // Alterna os botões
        document.getElementById('btnEditar').style.display = 'block';
        document.getElementById('btnAtualizar').style.display = 'block';
    }

    // --- 4. UTILITÁRIOS VISUAIS ---
    function mostrarErro(inputId, erroId) {
        document.getElementById(inputId).classList.add("erro");
        document.getElementById(erroId).style.display = "block";
    }
    function removerErro(inputId, erroId) {
        document.getElementById(inputId).classList.remove("erro");
        document.getElementById(erroId).style.display = "none";
    }

    // --- 5. ATUALIZAR ---
    function atualizar() {
        let valido = true;

        const campos = [
            { id: 'razaoSocial', erro: 'erro-razao' },
            { id: 'nomeCompleto', erro: 'erro-nome' },
            { id: 'cnpj', erro: 'erro-cnpj', len: 18 },
            { id: 'telefone', erro: 'erro-telefone', len: 14 },
            { id: 'cep', erro: 'erro-cep', len: 9 },
            { id: 'cidade', erro: 'erro-cidade' },
            { id: 'logradouro', erro: 'erro-logradouro' },
            { id: 'bairro', erro: 'erro-bairro' },
            { id: 'numero', erro: 'erro-numero' }
        ];

        // Validação Inputs
        campos.forEach(c => {
            const el = document.getElementById(c.id);
            if(el.value.trim() === "" || (c.len && el.value.length < c.len)) {
                mostrarErro(c.id, c.erro);
                valido = false;
            } else {
                removerErro(c.id, c.erro);
            }
        });

        // Validação Selects
        ['setorUsuario', 'cargoUsuario', 'uf'].forEach(id => {
            const el = document.getElementById(id);
            const spanId = 'erro-' + id.replace('Usuario', '').toLowerCase();
            if(el.value === "0" || el.value === "setor") {
                mostrarErro(id, spanId);
                valido = false;
            } else {
                removerErro(id, spanId);
            }
        });

        if (!valido) return alert("Preencha todos os campos corretamente.");

        // Recupera ID da empresa
        const idEmpresaFinal = idEmpresaGlobal || sessionStorage.ID_EMPRESA;
        if(!idEmpresaFinal) {
            alert("Erro: ID da Empresa não identificado.");
            return;
        }

        // Monta o objeto (Limpando as máscaras aqui para evitar erro 500)
        const corpo = {
            idEmpresa: idEmpresaFinal,
            razaoSocial: document.getElementById('razaoSocial').value,
            nome: document.getElementById('nomeCompleto').value,
            setor: document.getElementById('setorUsuario').value,
            // Remove pontos e traços antes de enviar
            cnpj: document.getElementById('cnpj').value.replace(/\D/g, ""),
            telefone: document.getElementById('telefone').value.replace(/\D/g, ""),
            cep: document.getElementById('cep').value.replace(/\D/g, ""),
            cargo: document.getElementById('cargoUsuario').value,
            cidade: document.getElementById('cidade').value,
            logradouro: document.getElementById('logradouro').value,
            numero: document.getElementById('numero').value,
            bairro: document.getElementById('bairro').value,
            uf: document.getElementById('uf').value,
            complemento: document.getElementById('complemento').value
        };

        const idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/empresa/info/${idUsuario}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(corpo)
        })
        .then(async res => {
            if(!res.ok) {
                const err = await res.json();
                throw new Error(err.sqlMessage || JSON.stringify(err));
            }
            return res.json();
        })
        .then(() => {
            alert("Dados atualizados com sucesso!");
            window.location.reload();
        })
        .catch(err => {
            console.error(err);
            alert("Erro ao atualizar: " + err.message);
        });
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = '../../login.html';
    }
</script>